<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Secure Voter Login</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body {
  background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}
.card {
  background: white;
  border-radius: 1rem;
  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}
.card:hover {
  transform: translateY(-5px);
  box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
}
.btn-primary {
  background: linear-gradient(to right, #4f46e5, #7c73e6);
  color: white;
  transition: all 0.3s ease;
}
.btn-primary:hover {
  background: linear-gradient(to right, #4338ca, #6d63d6);
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(79, 70, 229, 0.25);
}
.btn-secondary {
  background: linear-gradient(to right, #10b981, #34d399);
  color: white;
  transition: all 0.3s ease;
}
.btn-secondary:hover {
  background: linear-gradient(to right, #059669, #10b981);
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(16, 185, 129, 0.25);
}
.input-field {
  background: rgba(255, 255, 255, 0.9);
  border: 1px solid #e2e8f0;
  transition: all 0.3s ease;
}
.input-field:focus {
  border-color: #4f46e5;
  box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.15);
}
.section-title {
  color: #1e293b;
  position: relative;
  padding-bottom: 0.5rem;
}
.section-title:after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 0;
  width: 40px;
  height: 3px;
  background: linear-gradient(90deg, #4f46e5 0%, #6366f1 100%);
  border-radius: 3px;
}
</style>
</head>
<body class="flex items-center justify-center min-h-screen px-6 relative py-10">

<!-- Main Card -->
<div class="card w-full max-w-4xl p-8 md:p-10">
  <h2 class="text-3xl md:text-4xl font-bold text-center mb-8 text-slate-800">
    Secure <span class="text-indigo-600">Voter Login</span>
  </h2>

  <div class="flex flex-col lg:flex-row gap-8">
    <!-- Webcam + Face Login -->
    <div class="flex-1 flex flex-col items-center justify-center">
      <div class="w-full max-w-md p-6 mb-6 border border-slate-200 rounded-xl">
        <h3 class="text-xl font-semibold text-slate-700 mb-4 text-center section-title">Facial Recognition</h3>
        <video id="video" autoplay class="rounded-lg shadow-md border border-slate-200 w-full mb-6 h-64 object-cover"></video>
        <button id="faceLoginBtn" class="btn-primary w-full px-6 py-3 rounded-lg font-semibold">Facial Recognition Login</button>
      </div>
    </div>

    <!-- OTP Section -->
    <div id="otpSection" class="flex-1 flex flex-col justify-center border border-slate-200 p-6 rounded-xl space-y-4 hidden">
      <h3 class="text-xl font-semibold text-slate-700 mb-2 text-center section-title">Two-Factor Verification</h3>
      <input id="otpEmail" type="email" placeholder="Your email address"
        class="input-field w-full px-4 py-3 rounded-md text-slate-700 placeholder-slate-500" readonly />

      <input id="otpInput" type="text" placeholder="Enter verification code" maxlength="6"
        class="hidden input-field w-full px-4 py-3 rounded-md text-slate-700 placeholder-slate-500" />

      <!-- Verify OTP button -->
      <button id="verifyOtpBtn"
        class="hidden btn-secondary w-full px-6 py-3 rounded-lg font-semibold">
        Verify Code
      </button>
    </div>
  </div>

  <!-- Vote Button Container -->
  <div id="voteBtnContainer" class="mt-8 text-center"></div>

  <div class="text-slate-600 mt-8 text-center text-sm">
    New to the voting system? 
    <a href="/Voter_registration" class="text-indigo-600 hover:text-indigo-800 font-medium transition-colors">Register your profile</a>
  </div>
</div>

<!-- Loading Modal -->
<div id="loadingModal" class="fixed inset-0 flex items-center justify-center bg-white bg-opacity-80 hidden z-50">
  <div class="bg-white p-6 rounded-lg shadow-xl flex flex-col items-center">
    <div class="w-12 h-12 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin mb-4"></div>
    <div class="text-slate-700 font-medium">Processing your request...</div>
  </div>
</div>

<!-- Info Modal -->
<div id="modalBg" class="fixed inset-0 flex items-center justify-center bg-slate-900 bg-opacity-50 hidden z-50">
  <div class="bg-white p-6 rounded-lg shadow-xl max-w-lg w-full mx-4" id="modalContent"></div>
</div>

<script>
const video = document.getElementById('video');
const faceLoginBtn = document.getElementById('faceLoginBtn');
const otpSection = document.getElementById('otpSection');
const otpEmail = document.getElementById('otpEmail');
const otpInput = document.getElementById('otpInput');
const verifyOtpBtn = document.getElementById('verifyOtpBtn');
const loadingModal = document.getElementById('loadingModal');
const modalBg = document.getElementById('modalBg');
const modalContent = document.getElementById('modalContent');
const voteBtnContainer = document.getElementById('voteBtnContainer');

let otpVerified = false;

// Start webcam
navigator.mediaDevices.getUserMedia({ video: true })
  .then(stream => { video.srcObject = stream; })
  .catch(err => console.error("Webcam access denied: ", err));

function toggleLoading(show) {
  loadingModal.classList.toggle('hidden', !show);
}

function showModal(html) {
  modalContent.innerHTML = html;
  modalBg.classList.remove('hidden');
  modalBg.addEventListener('click', () => modalBg.classList.add('hidden'), { once: true });
}

function captureImage() {
  const canvas = document.createElement('canvas');
  canvas.width = video.videoWidth || 640;
  canvas.height = video.videoHeight || 480;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  return new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
}

async function checkResultOrVote() {
  try {
    const response = await fetch('/check-result-or-vote', { method: 'POST' });
    const result = await response.json();

    if (result.redirectTo === 'result') {
      window.location.href = '/result';
    } else if (result.message) {
      showModal(result.message);
    } else {
      window.location.href = '/candidates';
    }
  } catch (err) {
    console.error(err);
    showModal('<div class="text-center p-4"><div class="text-red-600 font-medium text-lg">An error occurred. Please try again.</div></div>');
  }
}

// Handle Face Login
faceLoginBtn.addEventListener('click', async () => {
  faceLoginBtn.disabled = true;
  faceLoginBtn.innerText = "Processing...";
  toggleLoading(true);

  try {
    const imageBlob = await captureImage();
    const formData = new FormData();
    formData.append('photo', imageBlob, 'face.png');

    const response = await fetch('/face-login', { method: 'POST', body: formData });
    const result = await response.json();

    toggleLoading(false);
    faceLoginBtn.disabled = false;
    faceLoginBtn.innerText = "Facial Recognition Login";

    if (result.status === 'error') {
      showModal(`
        <div class="text-center p-4">
          <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </div>
          <h2 class="text-xl font-bold mb-2 text-red-600">Verification Failed</h2>
          <p class="text-slate-600">${result.message}</p>
        </div>
      `);
    } else {
      const data = result.data;

      otpSection.classList.remove("hidden"); 
      otpEmail.value = data.email;           
      otpInput.classList.remove("hidden");
      verifyOtpBtn.classList.remove("hidden");

      // Profile preview
      showModal(`
        <div class="text-center">
          <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
            </svg>
          </div>
          <h2 class="text-xl font-bold mb-4 text-slate-800">Identity Verified</h2>
          <div class="flex flex-col items-center mt-4">
            <img src="${data.photo}" alt="User Photo" class="w-24 h-24 rounded-full border-4 border-indigo-100 shadow-md mb-4" />
            <div class="text-left space-y-2 text-slate-600">
              <p><strong class="text-slate-800">Name:</strong> ${data.name}</p>
              <p><strong class="text-slate-800">Email:</strong> ${data.email}</p>
            </div>
          </div>
          <p class="mt-6 text-sm text-slate-500">Please check your email for the verification code to continue</p>
        </div>
      `);
    }

  } catch (err) {
    toggleLoading(false);
    faceLoginBtn.disabled = false;
    faceLoginBtn.innerText = "Facial Recognition Login";
    showModal(`
      <div class="text-center p-4">
        <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
          </svg>
        </div>
        <h2 class="text-xl font-bold mb-2 text-red-600">System Error</h2>
        <p class="text-slate-600">Something went wrong. Please try again.</p>
      </div>
    `);
    console.error(err);
  }
});

// Handle OTP verification
async function handleOtpVerify() {
  const otp = otpInput.value.trim();
  const email = otpEmail.value.trim();
  if (!otp) {
    showModal(`
      <div class="text-center p-4">
        <div class="w-12 h-12 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-4">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-yellow-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
          </svg>
        </div>
        <p class="text-slate-700">Please enter the verification code before proceeding.</p>
      </div>
    `);
    return;
  }

  try {
    const res = await fetch('/verify-otp', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, otp }),
      credentials: "include"
    });
    const result = await res.json();

    if (result.success) {
      otpVerified = true;

      otpInput.disabled = true;
      verifyOtpBtn.disabled = true;
      verifyOtpBtn.innerText = "Verified âœ…";

      // Place Let's Vote button in permanent container
      voteBtnContainer.innerHTML = `
        <button onclick="checkResultOrVote()" 
          class="btn-primary mt-4 px-8 py-3 rounded-lg font-semibold text-lg">
          Proceed to Voting
        </button>
      `;

      showModal(`
        <div class="text-center p-4">
          <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
            </svg>
          </div>
          <h2 class="text-xl font-bold text-green-600 mb-2">Verification Successful</h2>
          <p class="text-slate-600">You can now proceed to cast your vote.</p>
        </div>
      `);

    } else {
      showModal(`
        <div class="text-center p-4">
          <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </div>
          <h2 class="text-xl font-bold text-red-600 mb-2">Invalid Code</h2>
          <p class="text-slate-600">${result.message || "The verification code you entered is invalid."}</p>
        </div>
      `);
    }
  } catch (err) {
    showModal(`
      <div class="text-center p-4">
        <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        </div>
        <h2 class="text-xl font-bold text-red-600 mb-2">Verification Failed</h2>
        <p class="text-slate-600">Please try again.</p>
      </div>
    `);
    console.error(err);
  }
}

verifyOtpBtn.addEventListener('click', handleOtpVerify);
</script>
</body>